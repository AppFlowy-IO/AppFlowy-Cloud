<!doctype html>
<html lang="en">
  <head>
    {% include "style.html" %}
  </head>
  <body>
    {% include "message.html" %}
    <h2 class="text-align-center">AppFlowy Cloud</h2>
    <table class="text-align-center justify-content-center display-flex">
      <tr>
        <td>
          <h3>Email Login</h3>
        </td>
      </tr>
      <tr>
        <td>
          <input
            class="text-align-center"
            type="text"
            id="email"
            name="email"
            placeholder="Email"
            required
          />
        </td>
      </tr>
      <tr>
        <td>
          <input
            class="text-align-center"
            type="password"
            id="password"
            name="password"
            placeholder="Password"
            required
          />
        </td>
      </tr>
      <tr>
        <td>
          <button type="button" id="submitBtn">Submit</button>
        </td>
      </tr>
    </table>

    <br />
    <table class="text-align-center justify-content-center display-flex">
      <tr>
        <td>
          <h3>OAuth2 Login</h3>
        </td>
      </tr>
      <tr>
        <td>
          <a href="/gotrue/authorize?provider=google&redirect_to=/web/login">
            <a href="/gotrue/authorize?provider=google&redirect_to=/web/login">
              <img
                src="https://static-00.iconduck.com/assets.00/google-icon-2048x2048-czn3g8x8.png"
                alt="Login with Google"
                width="30"
                height="30"
              />
            </a>
          </a>
        </td>
      </tr>
    </table>

    <script>
      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          var data = {
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
          };
          fetch("/web-api/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
            credentials: "same-origin",
          }).then((response) => {
            if (!response.ok) {
              response.text().then((text) => {
                displayMessage(`Login failed: ${response.statusText} ${text}`);
              });
            } else {
              window.location.href = "/web/home";
            }
          });
        });

      if (window.location.hash) {
        // OAuth
        // Extract data from the URL fragment
        const fragmentData = window.location.hash.substring(1); // Remove the leading #
        const fragmentParams = new URLSearchParams(fragmentData); // Parse the fragment data as a URLSearchParams object
        const refreshToken = fragmentParams.get("refresh_token"); // Extract the refresh_token
        fetch(`/web-api/login_refresh/${refreshToken}`, {
          // Login in via refresh_token
          method: "POST",
        }).then((response) => {
          if (!response.ok) {
            response.text().then((text) => {
              displayMessage(
                `OAuth Login failed: ${response.statusText} ${text}`,
              );
            });
          }
          window.location.href = "/web/home";
        });
      }
    </script>
  </body>
</html>
